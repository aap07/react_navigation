{"ast":null,"code":"\"use strict\";\n\nvar _asyncToGenerator = require(\"@babel/runtime/helpers/asyncToGenerator\");\nvar _defineProperty = require(\"@babel/runtime/helpers/defineProperty\");\nvar _classCallCheck = require(\"@babel/runtime/helpers/classCallCheck\");\nvar _createClass = require(\"@babel/runtime/helpers/createClass\");\nfunction ownKeys(e, r) { var t = Object.keys(e); if (Object.getOwnPropertySymbols) { var o = Object.getOwnPropertySymbols(e); r && (o = o.filter(function (r) { return Object.getOwnPropertyDescriptor(e, r).enumerable; })), t.push.apply(t, o); } return t; }\nfunction _objectSpread(e) { for (var r = 1; r < arguments.length; r++) { var t = null != arguments[r] ? arguments[r] : {}; r % 2 ? ownKeys(Object(t), !0).forEach(function (r) { _defineProperty(e, r, t[r]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(e, Object.getOwnPropertyDescriptors(t)) : ownKeys(Object(t)).forEach(function (r) { Object.defineProperty(e, r, Object.getOwnPropertyDescriptor(t, r)); }); } return e; }\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nvar bunyan_1 = __importDefault(require(\"@expo/bunyan\"));\nvar loosely_validate_event_1 = __importDefault(require(\"@segment/loosely-validate-event\"));\nvar assert_1 = __importDefault(require(\"assert\"));\nvar fetch_retry_1 = __importDefault(require(\"fetch-retry\"));\nvar md5_1 = __importDefault(require(\"md5\"));\nvar node_fetch_1 = __importDefault(require(\"node-fetch\"));\nvar remove_trailing_slash_1 = __importDefault(require(\"remove-trailing-slash\"));\nvar uuid_1 = require(\"uuid\");\nvar version = require(\"./package.json\").version;\nvar retryableFetch = (0, fetch_retry_1.default)(node_fetch_1.default);\nvar setImmediate = global.setImmediate || process.nextTick.bind(process);\nvar Analytics = function () {\n  function Analytics(writeKey, dataPlaneURL) {\n    var _ref = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {},\n      _ref$enable = _ref.enable,\n      enable = _ref$enable === void 0 ? true : _ref$enable,\n      _ref$timeout = _ref.timeout,\n      timeout = _ref$timeout === void 0 ? 0 : _ref$timeout,\n      _ref$flushAt = _ref.flushAt,\n      flushAt = _ref$flushAt === void 0 ? 20 : _ref$flushAt,\n      _ref$flushInterval = _ref.flushInterval,\n      flushInterval = _ref$flushInterval === void 0 ? 20000 : _ref$flushInterval,\n      _ref$maxFlushSizeInBy = _ref.maxFlushSizeInBytes,\n      maxFlushSizeInBytes = _ref$maxFlushSizeInBy === void 0 ? 1024 * 1000 * 3.9 : _ref$maxFlushSizeInBy,\n      _ref$maxQueueLength = _ref.maxQueueLength,\n      maxQueueLength = _ref$maxQueueLength === void 0 ? 1000 : _ref$maxQueueLength,\n      _ref$logLevel = _ref.logLevel,\n      logLevel = _ref$logLevel === void 0 ? bunyan_1.default.FATAL : _ref$logLevel;\n    _classCallCheck(this, Analytics);\n    this.inFlightFlush = null;\n    this.queue = [];\n    this.flushCallbacks = [];\n    this.flushResponses = [];\n    this.finalMessageId = null;\n    this.flushed = false;\n    this.timer = null;\n    this.enable = enable;\n    (0, assert_1.default)(writeKey, `The project's write key must be specified`);\n    (0, assert_1.default)(dataPlaneURL, `The data plane URL must be specified`);\n    this.writeKey = writeKey;\n    this.host = (0, remove_trailing_slash_1.default)(dataPlaneURL);\n    this.timeout = timeout;\n    this.flushAt = Math.max(flushAt, 1);\n    this.flushInterval = flushInterval;\n    this.maxFlushSizeInBytes = maxFlushSizeInBytes;\n    this.maxQueueLength = maxQueueLength;\n    this.logger = bunyan_1.default.createLogger({\n      name: '@expo/rudder-node-sdk',\n      level: logLevel\n    });\n  }\n  _createClass(Analytics, [{\n    key: \"identify\",\n    value: function identify(message, callback) {\n      this.validate(message, 'identify');\n      this.enqueue('identify', message, callback);\n      return this;\n    }\n  }, {\n    key: \"group\",\n    value: function group(message, callback) {\n      this.validate(message, 'group');\n      this.enqueue('group', message, callback);\n      return this;\n    }\n  }, {\n    key: \"track\",\n    value: function track(message, callback) {\n      this.validate(message, 'track');\n      this.enqueue('track', message, callback);\n      return this;\n    }\n  }, {\n    key: \"page\",\n    value: function page(message, callback) {\n      this.validate(message, 'page');\n      this.enqueue('page', message, callback);\n      return this;\n    }\n  }, {\n    key: \"screen\",\n    value: function screen(message, callback) {\n      this.validate(message, 'screen');\n      this.enqueue('screen', message, callback);\n      return this;\n    }\n  }, {\n    key: \"alias\",\n    value: function alias(message, callback) {\n      this.validate(message, 'alias');\n      this.enqueue('alias', message, callback);\n      return this;\n    }\n  }, {\n    key: \"validate\",\n    value: function validate(message, type) {\n      try {\n        (0, loosely_validate_event_1.default)(message, type);\n      } catch (e) {\n        if (e.message === 'Your message must be < 32kb.') {\n          this.logger.warn('Your message must be < 32KiB. This is currently surfaced as a warning. Please update your code.', message);\n          return;\n        }\n        throw e;\n      }\n    }\n  }, {\n    key: \"enqueue\",\n    value: function enqueue(type, message) {\n      var callback = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : function () {};\n      var _a, _b;\n      if (!this.enable) {\n        setImmediate(callback);\n        return;\n      }\n      if (this.queue.length >= this.maxQueueLength) {\n        this.logger.error(`Not adding events for processing as queue size ${this.queue.length} exceeds max configuration ${this.maxQueueLength}`);\n        setImmediate(callback);\n        return;\n      }\n      if (type === 'identify') {\n        (_a = message.traits) !== null && _a !== void 0 ? _a : message.traits = {};\n        (_b = message.context) !== null && _b !== void 0 ? _b : message.context = {};\n        message.context.traits = message.traits;\n      }\n      message = _objectSpread({}, message);\n      message.type = type;\n      message.context = _objectSpread({\n        library: {\n          name: '@expo/rudder-sdk-node',\n          version: version\n        }\n      }, message.context);\n      message._metadata = _objectSpread({\n        nodeVersion: process.versions.node\n      }, message._metadata);\n      if (!message.originalTimestamp) {\n        message.originalTimestamp = new Date();\n      }\n      if (!message.messageId) {\n        message.messageId = `node-${(0, md5_1.default)(JSON.stringify(message))}-${(0, uuid_1.v4)()}`;\n      }\n      this.queue.push({\n        message: message,\n        callback: callback\n      });\n      if (!this.flushed) {\n        this.flushed = true;\n        this.flush();\n        return;\n      }\n      var isDivisibleByFlushAt = this.queue.length % this.flushAt === 0;\n      if (isDivisibleByFlushAt) {\n        this.logger.debug(`flushAt reached, messageQueueLength is ${this.queue.length}, trying flush...`);\n        this.flush();\n      } else if (this.flushInterval && !this.timer) {\n        this.logger.debug('no existing flush timer, creating new one');\n        this.timer = setTimeout(this.flush.bind(this), this.flushInterval);\n      }\n    }\n  }, {\n    key: \"flush\",\n    value: function () {\n      var _flush = _asyncToGenerator(function* () {\n        var callback = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : function () {};\n        this.logger.debug('in flush');\n        this.finalMessageId = this.queue.length ? this.queue[this.queue.length - 1].message.messageId : null;\n        this.logger.trace('finalMessageId: ' + this.finalMessageId);\n        this.flushCallbacks.push(callback);\n        if (this.inFlightFlush) {\n          this.logger.debug('skipping flush, there is an in flight flush');\n          return yield this.inFlightFlush;\n        }\n        this.inFlightFlush = this.executeFlush();\n        var flushResponse = yield this.inFlightFlush;\n        this.logger.debug('resetting client flush state');\n        this.inFlightFlush = null;\n        this.finalMessageId = null;\n        this.logger.trace('===flushResponse===', flushResponse);\n        return flushResponse;\n      });\n      function flush() {\n        return _flush.apply(this, arguments);\n      }\n      return flush;\n    }()\n  }, {\n    key: \"executeFlush\",\n    value: function () {\n      var _executeFlush = _asyncToGenerator(function* () {\n        var _this = this;\n        var flushedItems = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];\n        var _a;\n        this.logger.debug('in execute flush');\n        if (!this.enable) {\n          this.logger.debug('client not enabled, skipping flush');\n          this.flushResponses.splice(0, this.flushResponses.length);\n          var nullResponse = this.nullFlushResponse();\n          this.flushCallbacks.splice(0, this.flushCallbacks.length).map(function (callback) {\n            return setImmediate(callback, nullResponse);\n          });\n          return nullResponse;\n        }\n        if (this.timer) {\n          this.logger.debug('cancelling existing timer...');\n          clearTimeout(this.timer);\n          this.timer = null;\n        }\n        if (!this.queue.length) {\n          this.logger.debug('queue is empty, nothing to flush');\n          this.flushResponses.splice(0, this.flushResponses.length);\n          var _nullResponse = this.nullFlushResponse();\n          this.flushCallbacks.splice(0, this.flushCallbacks.length).map(function (callback) {\n            return setImmediate(callback, _nullResponse);\n          });\n          return _nullResponse;\n        }\n        var flushSize = 0;\n        var spliceIndex = 0;\n        for (var i = 0; i < this.queue.length; i++) {\n          var item = this.queue[i];\n          var itemSize = JSON.stringify(item).length;\n          var exceededMaxFlushSize = flushSize + itemSize > this.maxFlushSizeInBytes;\n          if (exceededMaxFlushSize) {\n            break;\n          }\n          flushSize += itemSize;\n          spliceIndex++;\n          if (((_a = item.message.messageId) !== null && _a !== void 0 ? _a : null) === this.finalMessageId || !this.finalMessageId) {\n            break;\n          }\n        }\n        var itemsToFlush = this.queue.splice(0, spliceIndex);\n        var callbacks = itemsToFlush.map(function (item) {\n          return item.callback;\n        });\n        var currentBatchOfMessages = itemsToFlush.map(function (item) {\n          if (typeof item.message == 'object') {\n            item.message.sentAt = new Date();\n          }\n          return item.message;\n        });\n        var done = function done(err) {\n          callbacks.forEach(function (callback_) {\n            callback_(err);\n          });\n          var flushResponses = _this.flushResponses.slice(0, _this.flushResponses.length);\n          _this.flushCallbacks.splice(0, _this.flushCallbacks.length).map(function (callback) {\n            return setImmediate(callback, flushResponses);\n          });\n        };\n        var data = {\n          batch: currentBatchOfMessages,\n          sentAt: new Date()\n        };\n        this.logger.debug('batch size is ' + itemsToFlush.length);\n        this.logger.trace('===data===', data);\n        var req = {\n          method: 'POST',\n          headers: {\n            accept: 'application/json, text/plain, */*',\n            'content-type': 'application/json;charset=utf-8',\n            'user-agent': `expo-rudder-sdk-node/${version}`,\n            authorization: 'Basic ' + Buffer.from(`${this.writeKey}:`).toString('base64')\n          },\n          body: JSON.stringify(data),\n          timeout: this.timeout > 0 ? this.timeout : undefined,\n          retryDelay: this.getExponentialDelay.bind(this),\n          retryOn: this.isErrorRetryable.bind(this)\n        };\n        var error = undefined;\n        try {\n          var response = yield retryableFetch(`${this.host}`, req);\n          if (!response.ok) {\n            this.logger.error('request failed to send after 3 retries, dropping ' + itemsToFlush.length + ' events');\n            error = new Error(response.statusText);\n          }\n        } catch (err) {\n          this.logger.error('request failed to send after 3 retries, dropping ' + itemsToFlush.length + ' events');\n          error = err;\n        }\n        this.flushResponses.push({\n          error: error,\n          data: data\n        });\n        var finishedFlushing = currentBatchOfMessages[currentBatchOfMessages.length - 1].messageId === this.finalMessageId || !this.finalMessageId;\n        if (finishedFlushing) {\n          if (error) {\n            done(error);\n          } else {\n            done();\n          }\n          return this.flushResponses.splice(0, this.flushResponses.length);\n        }\n        callbacks.forEach(function (callback_) {\n          callback_(error);\n        });\n        return yield this.executeFlush(flushedItems.concat(itemsToFlush));\n      });\n      function executeFlush() {\n        return _executeFlush.apply(this, arguments);\n      }\n      return executeFlush;\n    }()\n  }, {\n    key: \"getExponentialDelay\",\n    value: function getExponentialDelay(priorRetryCount) {\n      var delay = 2 ** priorRetryCount * 200;\n      var jitter = delay * 0.2 * Math.random();\n      return delay + jitter;\n    }\n  }, {\n    key: \"isErrorRetryable\",\n    value: function isErrorRetryable(priorRetryCount, error, response) {\n      if (priorRetryCount > 2) {\n        return false;\n      }\n      return !!error || response.status === 429 || response.status >= 500 && response.status <= 599;\n    }\n  }, {\n    key: \"nullFlushResponse\",\n    value: function nullFlushResponse() {\n      return [{\n        data: {\n          batch: [],\n          sentAt: new Date()\n        }\n      }];\n    }\n  }]);\n  return Analytics;\n}();\nexports.default = Analytics;","map":{"version":3,"names":["bunyan_1","__importDefault","require","loosely_validate_event_1","assert_1","fetch_retry_1","md5_1","node_fetch_1","remove_trailing_slash_1","uuid_1","version","retryableFetch","default","setImmediate","global","process","nextTick","bind","Analytics","writeKey","dataPlaneURL","_ref","arguments","length","undefined","_ref$enable","enable","_ref$timeout","timeout","_ref$flushAt","flushAt","_ref$flushInterval","flushInterval","_ref$maxFlushSizeInBy","maxFlushSizeInBytes","_ref$maxQueueLength","maxQueueLength","_ref$logLevel","logLevel","FATAL","_classCallCheck","inFlightFlush","queue","flushCallbacks","flushResponses","finalMessageId","flushed","timer","host","Math","max","logger","createLogger","name","level","_createClass","key","value","identify","message","callback","validate","enqueue","group","track","page","screen","alias","type","e","warn","error","_a","traits","_b","context","_objectSpread","library","_metadata","nodeVersion","versions","node","originalTimestamp","Date","messageId","JSON","stringify","v4","push","flush","isDivisibleByFlushAt","debug","setTimeout","_flush","_asyncToGenerator","trace","executeFlush","flushResponse","apply","_executeFlush","_this","flushedItems","splice","nullResponse","nullFlushResponse","map","clearTimeout","flushSize","spliceIndex","i","item","itemSize","exceededMaxFlushSize","itemsToFlush","callbacks","currentBatchOfMessages","sentAt","done","err","forEach","callback_","slice","data","batch","req","method","headers","accept","authorization","Buffer","from","toString","body","retryDelay","getExponentialDelay","retryOn","isErrorRetryable","response","ok","Error","statusText","finishedFlushing","concat","priorRetryCount","delay","jitter","random","status","exports"],"sources":["index.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}